---
title: DolphinScheduler 调度平台
description: 详细介绍 Apache DolphinScheduler 的环境准备、用户配置、Zookeeper 部署及完整的安装流程
releaseDate: 2022-07-09
author:
  name: Richard Wang
  url: https://richardwang.me
---

Apache DolphinScheduler 是一个分布式、易扩展的可视化 DAG 工作流任务调度平台。本文将介绍如何在 Linux 环境下从零开始部署 DolphinScheduler，包括用户配置、环境依赖安装以及服务部署等完整流程。

## 环境准备

### 配置用户及免密登录

首先我们需要创建一个专用的用户来运行 DolphinScheduler，并配置相应的权限。

1. **创建用户**

    ```bash
    useradd dolphinscheduler
    ```

2. **设置密码**

    ```bash
    echo "dolphinscheduler" | passwd --stdin dolphinscheduler
    ```

3. **配置 sudo 权限**

    ```bash
    sed -i '$adolphinscheduler  ALL=(ALL)  NOPASSWD: NOPASSWD: ALL' /etc/sudoers
    sed -i 's/Defaults    requirett/#Defaults    requirett/g' /etc/sudoers
    ```

4. **修改目录权限**

    ```bash
    chown -R dolphinscheduler:dolphinscheduler /opt
    ```

### 配置 SSH 免密登陆

集群节点间（即便是单机部署）需要通过 SSH 进行通信，因此需要配置免密登录。

1. 切换到 `dolphinscheduler` 用户：

    ```bash
    su dolphinscheduler
    ```

2. 生成密钥对：

    ```bash
    ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa
    ```

3. 将公钥添加到认证文件：

    ```bash
    cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    ```

4. 修改权限：

    ```bash
    chmod 600 ~/.ssh/authorized_keys
    ```

### 创建所需目录

我们需要规划好软件安装和数据存储的目录结构：

```bash
mkdir -p /opt/bigdata # 用于存放大数据组件
mkdir -p /opt/software # 用于存放安装包
mkdir -p /opt/zkdata # 用于存放 zookeeper 数据
```

### 安装 JDK

DolphinScheduler 依赖 Java 环境。

1. 将 JDK 安装包上传到 `/opt/software` 目录下。
2. 解压到 `/opt/bigdata` 目录：

    ```bash
    tar -zxvf /opt/software/jdk-8u381-linux-x64.tar.gz -C /opt/bigdata
    ```

3. 创建软链接以便于版本管理：

    ```bash
    ln -s /opt/bigdata/jdk1.8.0_381 /opt/bigdata/jdk
    ```

4. 配置环境变量：

    ```bash
    sudo vim /etc/profile.d/bigdata.sh
    ```

    添加以下内容：

    ```bash
    export JAVA_HOME=/opt/bigdata/jdk
    export PATH=$JAVA_HOME/bin:$PATH
    ```

5. 使环境变量生效：

    ```bash
    source /etc/profile.d/bigdata.sh
    ```

### 安装 Zookeeper

DolphinScheduler 使用 Zookeeper 进行集群管理。

1. **下载并解压**

    ```bash
    wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.2/apache-zookeeper-3.8.2-bin.tar.gz -O /opt/software/apache-zookeeper-3.8.2-bin.tar.gz
    tar -zxvf /opt/software/apache-zookeeper-3.8.2-bin.tar.gz -C /opt/bigdata
    ```

2. **创建软链接**

    ```bash
    ln -s /opt/bigdata/apache-zookeeper-3.8.2-bin /opt/bigdata/zookeeper
    ```

3. **修改配置**

    复制样例配置文件并进行修改：

    ```bash
    mv /opt/bigdata/zookeeper/conf/zoo_sample.cfg /opt/bigdata/zookeeper/conf/zoo.cfg
    vim /opt/bigdata/zookeeper/conf/zoo.cfg
    ```

    指定数据存储目录：

    ```bash
    dataDir=/opt/zkdata
    ```

4. **启动服务**

    ```bash
    /opt/bigdata/zookeeper/bin/zkServer.sh start
    ```

## 安装部署

### 准备安装包与驱动

1. **下载安装包**

    ```bash
    wget https://dlcdn.apache.org/dolphinscheduler/3.1.7/apache-dolphinscheduler-3.1.7-bin.tar.gz -O /opt/software/apache-dolphinscheduler-3.1.7-bin.tar.gz
    tar -zxvf /opt/software/apache-dolphinscheduler-3.1.7-bin.tar.gz -C /opt/software
    ```

2. **配置 MySQL 驱动**

    <Callout type="info">
    由于协议限制，DolphinScheduler 安装包不含 MySQL 驱动。我们需要自行下载并分发到各服务目录。
    </Callout>

    下载驱动：

    ```bash
    wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-8.0.16.tar.gz -O /opt/software/mysql-connector-java-8.0.16.tar.gz
    tar -zxvf /opt/software/mysql-connector-java-8.0.16.tar.gz -C /opt/software
    ```

    分发 jar 包到各个服务的 `libs` 目录：

    ```bash
    cp /opt/software/mysql-connector-java-8.0.16/mysql-connector-java-8.0.16.jar /opt/software/apache-dolphinscheduler-3.1.7-bin/alert-server/libs
    cp /opt/software/mysql-connector-java-8.0.16/mysql-connector-java-8.0.16.jar /opt/software/apache-dolphinscheduler-3.1.7-bin/api-server/libs
    cp /opt/software/mysql-connector-java-8.0.16/mysql-connector-java-8.0.16.jar /opt/software/apache-dolphinscheduler-3.1.7-bin/master-server/libs
    cp /opt/software/mysql-connector-java-8.0.16/mysql-connector-java-8.0.16.jar /opt/software/apache-dolphinscheduler-3.1.7-bin/worker-server/libs
    cp /opt/software/mysql-connector-java-8.0.16/mysql-connector-java-8.0.16.jar /opt/software/apache-dolphinscheduler-3.1.7-bin/tools/libs
    ```

    <Callout type="warn">
    - 若使用 MySQL 作为元数据库，驱动版本建议为 8.0.16。
    - **注意**：`tools` 目录也需要 MySQL 驱动，否则初始化元数据库时会失败。这一点容易被忽略。
    </Callout>

### 初始化元数据库

我们将使用 MySQL 存储 DolphinScheduler 的元数据。

1. **创建数据库和用户**

    ```bash
    mysql -uroot -p
    ```

    在 MySQL Shell 中执行：

    ```sql
    CREATE DATABASE dolphinscheduler DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;

    -- 修改 {user} 和 {password} 为实际值
    CREATE USER 'homelabscheduler'@'%' IDENTIFIED BY 'yourpassword';
    GRANT ALL PRIVILEGES ON dolphinscheduler.* TO 'homelabscheduler'@'%';
    CREATE USER 'homelabscheduler'@'localhost' IDENTIFIED BY 'yourpassword';
    GRANT ALL PRIVILEGES ON dolphinscheduler.* TO 'homelabscheduler'@'localhost';
    FLUSH PRIVILEGES;
    ```

2. **修改数据源配置**

    编辑 `dolphinscheduler_env.sh`：

    ```bash
    vim /opt/software/apache-dolphinscheduler-3.1.7-bin/bin/env/dolphinscheduler_env.sh
    ```

    配置 JAVA_HOME 和数据库连接：

    ```bash
    export JAVA_HOME=${JAVA_HOME:-/opt/bigdata/jdk}
    ...
    export DATABASE=${DATABASE:-mysql}
    export SPRING_PROFILES_ACTIVE=${DATABASE}
    export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/dolphinscheduler?useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true"
    export SPRING_DATASOURCE_USERNAME={user}
    export SPRING_DATASOURCE_PASSWORD={password}
    ```

    <Callout type="warn">
    `SPRING_DATASOURCE_URL` 中必须包含 `&allowPublicKeyRetrieval=true`，否则初始化可能会报错。
    </Callout>

3. **执行初始化**

    ```bash
    bash /opt/software/apache-dolphinscheduler-3.1.7-bin/tools/bin/upgrade-schema.sh
    ```

### 执行部署

1. **修改安装配置**

    编辑 `install_env.sh`：

    ```bash
    vim /opt/software/apache-dolphinscheduler-3.1.7-bin/bin/env/install_env.sh
    ```

    设置部署参数：

    ```bash
    ips="localhost"
    sshPort="22"
    masters="localhost"
    workers="localhost:default"
    alertServer="localhost"
    apiServers="localhost"
    installPath="/opt/bigdata/dolphinscheduler"
    deployUser="dolphinscheduler" # 之前创建的用户
    ```

2. **配置环境变量（可选）**

    如果任务需要 Hadoop、Spark 等组件，需在 `dolphinscheduler_env.sh` 中配置对应路径：

    ```bash
    export HADOOP_HOME=${HADOOP_HOME:-/opt/soft/hadoop}
    export HADOOP_CONF_DIR=${HADOOP_CONF_DIR:-/opt/soft/hadoop/etc/hadoop}
    # ... 其他组件配置
    ```

3. **一键部署**

    确保以 `dolphinscheduler` 用户身份执行，且 Zookeeper 正常运行：

    ```bash
    bash /opt/software/apache-dolphinscheduler-3.1.7-bin/bin/install.sh
    ```

4. **服务管理**

    ```bash
    # 启动全部服务
    bash /opt/software/apache-dolphinscheduler-3.1.7-bin/bin/start-all.sh

    # 停止全部服务
    bash /opt/software/apache-dolphinscheduler-3.1.7-bin/bin/stop-all.sh
    ```

### 访问 Web UI

为了从外部访问，需开放端口或关闭防火墙。

- **开放端口**：

    ```bash
    sudo firewall-cmd --zone=public --add-port=12345/tcp --permanent
    sudo firewall-cmd --reload
    ```

- **或者关闭防火墙**：

    ```bash
    sudo systemctl stop firewalld.service
    sudo systemctl disable firewalld.service
    ```

访问地址：`http://localhost:12345/dolphinscheduler/ui`

<Callout type="info">
默认账户：**admin**
默认密码：**dolphinscheduler123**
</Callout>

<Callout type="warn">
访问 URL 中的 `/dolphinscheduler/ui` 路径不能省略。
</Callout>

部署完成后，登录系统，你将看到如下仪表盘（Dashboard）界面。界面主要展示了任务状态统计和流程状态统计，包含各类运行状态（如成功、失败、正在运行等）的饼状图及具体数量统计：

![DolphinScheduler 仪表盘界面](/development/self-hosted/dolphinscheduler-dashboard.png)
