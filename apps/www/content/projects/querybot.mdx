---
title: QueryBot
description: 基于 LangGraph 的智能查询机器人，将自然语言转换为 SQL 查询并执行
date: 2024-02-15
category: opensource
logo: /projects/github.svg
tech:
  - LangChain
  - Milvus
  - FastAPI
  - Streamlit
  - Python
links:
  github: https://github.com/i-richardwang/QueryBot
  url: https://querybot.streamlit.app
featured: true
---

由 LangGraph 驱动的智能查询机器人，将自然语言转换为精确的 SQL 查询并执行。通过 13 节点处理流程，QueryBot 实现了从意图理解、术语映射、SQL 生成到错误修复的完整工作流，结合向量语义搜索和多轮对话能力，让数据查询变得像聊天一样简单。

## 系统架构

![系统架构图](/projects/querybot/querybot.png)

QueryBot 采用智能的图工作流架构，从用户的自然语言输入开始，通过 13 个专业化节点处理查询转换的每个环节。

**意图识别节点** - 系统的核心决策点，判断用户请求是否清晰明确。当意图不明确时主动提问而非盲目执行，意图清晰时进入后续处理流程，对于不支持的操作诚实告知限制。

**自然语言处理链** - 从自然语言中提取查询要素（时间范围、筛选条件、聚合方式等），将业务术语映射到标准数据库字段，规范化表达并消除歧义。

**向量检索增强** - 基于 Milvus 向量数据库的智能检索系统。通过语义搜索快速定位相关数据表，查找历史相似查询案例提供 SQL 生成参考，支持同义词和模糊匹配理解用户的各种表达方式。

**SQL 生成和执行** - 验证查询可行性，基于所有上下文信息生成标准 SQL 语句，根据用户角色注入数据访问权限条件，在数据库中安全执行并返回结果。

**错误修复机制** - 捕获 SQL 语法错误和字段不存在等问题，智能判断错误类型和根源，根据错误类型重新生成正确的 SQL，支持多次修复尝试提高成功率。

整个流程通过 LangGraph 的图工作流控制，每个节点可以根据处理结果动态决定下一步。遇到错误可以回退到前面的节点重试，而不是整个流程重来。

## 使用流程

![QueryBot 演示](/projects/querybot/demo.gif)

用户输入自然语言查询后，系统会展示完整的处理过程：意图理解、关键词提取、表结构匹配、SQL 生成、权限注入、执行查询。界面同时展示生成的 SQL 语句和查询结果，帮助用户理解系统的工作逻辑。

系统支持简单筛选查询、聚合统计查询和多表关联查询。对于复杂的统计分析，会自动识别需要的表关联、聚合计算和条件筛选，无需用户了解 SQL 语法。

## 核心特性

**智能意图理解**  
系统不会盲目执行所有输入。当用户问题缺少必要信息时主动提问，当请求超出系统能力范围时明确说明限制。这种主动澄清机制减少了无效执行和错误结果，提升了交互体验。

**向量语义搜索**  
使用向量数据库（Milvus）存储表结构、字段说明和历史查询案例，通过语义相似度搜索找到最相关的信息。支持术语映射（"流失率" / "离职率" → `retention_rate`）、表结构理解和示例查询匹配，即使用户表述不标准也能准确识别。

**SQL 错误修复**  
生成的 SQL 不一定第一次就正确。系统实现了智能的错误恢复机制：检测语法错误、字段不存在、表不存在等问题，自动回到相应节点重新处理。每次修复尝试都会记录在状态中，通过 Langfuse 可以追踪完整的修复过程。

**权限和安全控制**  
所有参数都经过验证和转义，使用参数化查询防止 SQL 注入。支持基于用户角色的权限管理，系统可以自动在生成的 SQL 中注入权限过滤条件。记录所有查询历史、执行时间、访问用户等信息，满足合规性要求。

## 技术架构

### 技术栈

| 层次 | 技术 | 用途 |
|------|------|------|
| **前端** | Streamlit | Web 交互界面 |
| **后端** | FastAPI | 异步 HTTP 接口服务 |
| **工作流引擎** | LangGraph | 智能流程控制 |
| **AI 框架** | LangChain | LLM 调用和工具链管理 |
| **向量数据库** | Milvus | 语义搜索和示例匹配 |
| **关系数据库** | MySQL/PostgreSQL | 业务数据存储 |
| **监控追踪** | Langfuse | LLM 调用链追踪和分析 |

### 项目结构

```
QueryBot/
├── backend/sql_assistant/         # 后端服务
│   ├── api.py                     # FastAPI 应用入口
│   ├── async_executor.py          # 异步任务执行器
│   ├── graph/                     # 工作流图定义
│   ├── nodes/                     # 13 个处理节点
│   ├── routes/                    # 条件路由逻辑
│   ├── states/                    # 状态数据结构
│   └── utils/                     # 工具函数
├── data/                          # 数据目录
│   ├── demo_data_csv/             # Demo 数据
│   ├── vector_db_csv/             # 向量数据库元数据
│   └── config/                    # 配置文件
├── tools/                         # 工具套件
│   ├── setup_demo_environment.py  # 智能环境设置向导
│   ├── data_generation/           # 数据生成工具
│   ├── mysql_import/              # MySQL 导入工具
│   └── vector_db_import/          # 向量数据库导入工具
├── frontend/                      # 前端界面 (Streamlit)
├── tools/admin/                   # 管理工具 (向量数据库管理)
└── utils/                         # 通用工具
    ├── core/                      # 基础设施模块
    ├── factories/                 # 连接工厂模块
    └── services/                  # 业务服务模块
```
