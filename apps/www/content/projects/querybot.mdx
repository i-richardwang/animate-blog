---
title: QueryBot
description: 基于 LangGraph 的智能查询机器人，将自然语言转换为 SQL 查询并执行
date: 2024-02-15
category: opensource
logo: /projects/github.svg
tech:
  - LangChain
  - Milvus
  - FastAPI
  - Streamlit
  - Python
links:
  github: https://github.com/i-richardwang/QueryBot
featured: true
---

由 LangGraph 驱动的智能查询机器人，具有先进的向量搜索和多数据库支持的自然语言到 SQL 转换功能。QueryBot 通过复杂的 13 节点状态机架构将自然语言业务问题转换为精确的 SQL 查询，展示了 AI Agent 如何处理复杂的数据查询工作流程。

## 核心功能

### 智能查询处理

**自然语言理解**  
通过先进的语言模型处理和语义分析，将复杂的自然语言查询转换为精确的 SQL 语句。

**意图分析**  
智能判断查询意图的清晰度，主动澄清模糊的需求。当用户问题缺少必要细节时，系统会提出针对性问题而不是做出假设。

**术语标准化**  
自动将业务别名映射到标准数据库字段。例如，即使用户以不同方式描述"客户流失率"，也可以将其映射到特定的数据库列。

**上下文感知**  
基于对话历史和业务上下文理解查询意图，能够更准确地解释后续问题。

### 智能工作流引擎

**图状态机架构**  
基于 LangGraph 构建，包含 13 个专业化处理节点，每个节点处理查询转换过程的特定方面。这种模块化方法确保了清晰性和可维护性。

**动态路由**  
根据处理结果智能确定下一步操作。系统可以跳过不必要的步骤或循环返回进行错误纠正。

**错误恢复**  
自动 SQL 错误检测和修复机制。当生成的 SQL 失败时，系统会分析错误并尝试修复，支持多轮重试。

**流程可视化**  
通过集成工具实现完整的处理流程追踪和监控，使开发人员能够理解系统行为并优化性能。

### 数据安全

**SQL 注入防护**  
实现参数化查询和输入验证，防止 SQL 注入攻击，确保数据库安全。

**数据访问控制**  
基于环境的数据库访问管理，具有可配置的权限，支持不同用户类型的基于角色的访问控制。

**审计日志**  
维护完整的查询历史和操作记录，用于合规性和调试。

### 向量语义搜索

**表结构理解**  
表描述和结构信息的向量化存储，通过语义搜索快速识别相关表。

**查询示例匹配**  
基于存储在向量数据库中的相似历史查询智能生成 SQL，提高常见查询模式的准确性。

**术语语义搜索**  
支持业务术语查找的模糊匹配和语义理解，处理用户表达同一概念的不同方式。

### 可扩展架构

**模块化设计**  
每个处理节点都有单一职责，易于维护和扩展。开发人员可以修改单个节点而不影响整个系统。

**本地开发**  
简化的演示和开发环境设置，提供用于数据生成和环境配置的全面工具。

**多数据库支持**  
混合架构，MySQL/PostgreSQL 用于关系数据，Milvus 用于向量操作，提供结构化查询和语义搜索功能。

**监控和追踪**  
集成 Langfuse 和 Phoenix，实现 LLM 调用、性能指标和成本追踪的全链路监控。

## 系统架构

### 核心处理流程

QueryBot 的核心是一个 13 节点的图状态机，处理从自然语言到 SQL 执行的完整流程：

**意图分析** → **关键词提取** → **术语映射** → **查询重写** → **数据源识别** → **表结构分析** → **可行性检查** → **查询示例检索** → **SQL 生成** → **权限控制** → **SQL 执行** → **错误分析（如需要）** → **结果生成**

每个节点专注一个任务，通过状态机控制执行顺序。遇到错误可以回退到前面的节点重试，而不是整个流程重来。这种设计提供了强大的容错能力和灵活性。

### 技术栈

| 层次 | 技术 | 用途 |
|------|------|------|
| **API 层** | FastAPI + uvicorn | 异步 HTTP 接口服务 |
| **工作流引擎** | LangGraph | 智能状态机和流程控制 |
| **AI 框架** | LangChain | LLM 调用和工具链管理 |
| **向量数据库** | Milvus | 语义搜索和向量存储 |
| **关系数据库** | MySQL/PostgreSQL | 业务数据和权限管理 |
| **监控追踪** | Langfuse/Phoenix | LLM 调用链追踪和分析 |

### 项目结构

```
QueryBot/
├── backend/sql_assistant/         # 后端服务
│   ├── api.py                     # FastAPI 应用入口
│   ├── async_executor.py          # 异步任务执行器
│   ├── graph/                     # 工作流图定义
│   ├── nodes/                     # 13 个处理节点
│   ├── routes/                    # 条件路由逻辑
│   ├── states/                    # 状态数据结构
│   └── utils/                     # 工具函数
├── data/                          # 数据目录
│   ├── demo_data_csv/             # Demo 数据
│   ├── vector_db_csv/             # 向量数据库元数据
│   └── config/                    # 配置文件
├── tools/                         # 工具套件
│   ├── setup_demo_environment.py  # 智能环境设置向导
│   ├── data_generation/           # 数据生成工具
│   ├── mysql_import/              # MySQL 导入工具
│   └── vector_db_import/          # 向量数据库导入工具
├── frontend/                      # 前端界面 (Streamlit)
├── tools/admin/                   # 管理工具 (向量数据库管理)
└── utils/                         # 通用工具
    ├── core/                      # 基础设施模块
    ├── factories/                 # 连接工厂模块
    └── services/                  # 业务服务模块
```

## 智能处理节点

QueryBot 包含 13 个专业化处理节点，每个节点负责流程中的特定环节：

| 节点 | 功能 | 输入 | 输出 |
|------|------|------|------|
| **意图分析** | 判断查询意图清晰度 | 用户查询 | 意图清晰度 |
| **关键词提取** | 提取关键查询信息 | 标准化查询 | 关键词列表 |
| **术语映射** | 标准化业务术语 | 关键词 | 标准术语 |
| **查询重写** | 规范化查询表达 | 映射结果 | 重写后的查询 |
| **数据源识别** | 识别相关数据表 | 重写后的查询 | 匹配的表列表 |
| **表结构分析** | 获取详细表信息 | 表列表 | 表结构信息 |
| **可行性检查** | 验证查询可行性 | 查询 + 结构 | 可行性结果 |
| **查询示例检索** | 查找相似查询 | 查询意图 | 示例 SQL |
| **SQL 生成** | 生成 SQL 语句 | 所有上下文 | SQL 查询 |
| **权限控制** | 注入权限条件 | SQL + 用户 | 安全 SQL |
| **SQL 执行** | 执行数据库查询 | 安全 SQL | 执行结果 |
| **错误分析** | 分析和修复错误 | 错误信息 | 修复方案 |
| **结果生成** | 格式化最终结果 | 执行结果 | 用户响应 |

## 向量语义搜索

用户问"上个季度的客户流失率"，系统需要知道"流失率"对应数据库的哪个字段、"上个季度"如何转换为日期范围。

QueryBot 维护了业务术语和数据库元数据的向量索引（Milvus）。当提取到关键词后，通过语义搜索找到最相关的表和字段。即使用户的表述和数据库命名不一致，也能准确映射。

系统支持三种向量搜索应用：
- **表结构理解**: 向量化存储表描述，快速找到相关数据表
- **示例查询匹配**: 存储历史查询和对应的 SQL，用相似查询生成新的 SQL
- **术语语义匹配**: 支持业务术语的模糊匹配和同义词理解

## SQL 修复和错误恢复

生成的 SQL 可能有语法错误、引用不存在的字段、逻辑错误等。QueryBot 的错误恢复机制包括：

1. **执行前验证**: 检查 SQL 语法和表/字段存在性
2. **执行时捕获**: 在数据库执行时捕获错误信息
3. **智能分析**: 分析错误原因（语法错误、字段不存在、权限不足等）
4. **自动修复**: 根据错误类型自动修复并重新生成 SQL
5. **多轮重试**: 支持多轮修复尝试，每次修复都记录在状态中

整个处理过程通过 Langfuse 进行追踪，可以清晰地看到每个节点的输入输出、LLM 调用情况、错误修复过程，便于调试和优化。

## 项目特点

**可靠的架构**  
图状态机提供清晰的处理流程和强大的错误恢复能力。多节点架构允许针对性的错误处理和流程优化。

**高准确率**  
通过向量搜索、术语映射、示例匹配多层提升准确性，显著减少转换错误。

**可观测性**  
集成 Langfuse 监控每个节点的输入/输出、LLM 调用和处理时间。

**易于扩展**  
模块化设计使添加新节点或修改现有逻辑变得简单。

**全面的工具链**  
提供数据生成脚本、环境配置向导、向量数据库管理工具和演示数据集导入器。
